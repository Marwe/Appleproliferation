User_habitat function

INTRODUCTION

This function calculates the amount of area within a buffer. With thousend of sample locations it is necessary to monitor join progress.
This functions allows to monitor to progress by "RAISE NOTICE".
Sample locations can be flexibly specified in an array, tables and column (variable for area calcultion, might have different types).


- function stores the ouput in the table „tmp“, which needs to be created before- an environmental table (_t_env regclass) and a buffer table (_t_buffer) can be dynamically assigned using the select function- the function avoids SQL injection: tables as regclass, column as quote_identFUNCTIONCREATE OR REPLACE FUNCTION user_habitat (anyarray, _t_env regclass, _c text, _t_buffer regclass)returns void AS $$declare x INT;beginforeach x in array $1loopRAISE NOTICE '%', x;EXECUTE 'INSERT INTO tmp (site_id,id, '|| quote_ident(_c) ||',area) (SELECT b.site_id,b.id, a. '|| quote_ident(_c) ||', SUM(ST_AREA(ST_Intersection(a.the_geom,b.the_geom))) as area FROM                                                                                                                                                              '|| _t_env||' as a,                                                                                                                                                                                                                                                          '|| _t_buffer||' as b                                                                                                                                                                                                                                                         WHERE ST_Intersects(a.the_geom,b.the_geom)                                                                                                                                                                                                                                      AND b.site_id = '||x||'                                                                                                                                                                                                                                                          GROUP BY site_id,b.id, a. '|| quote_ident(_c) ||') ' ;end loop;end;$$ language plpgsql;EXAMPLE USAGE:
CREATE TABLE tmp (site_id INT, id INT, hoh_bez_d VARCHAR(50), area DEC(50,2));SELECT user_habitat (ARRAY[1,2], 'forest_elev_zone', 'hoh_bez_d', 'apple_buffer_r5000');